<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace = "board">

  <insert id="create" parameterType="BoardVO">
    INSERT INTO board(boardno,
                  divisionno, me_no, title, content, good, file1, file2, size2, rdate, 
                  grpno, indent, ansnum)  
    VALUES((SELECT NVL(MAX(boardno), 0) + 1 as boardno FROM board),
                #{divisionno}, #{me_no}, #{title}, #{content},0, #{file1}, #{file2}, #{size2}, sysdate,
                (SELECT NVL(MAX(grpno), 0) + 1 as grpno FROM board), 0, 0)
  </insert>
  
  <select id="list" resultType="BoardVO">
    SELECT boardno,
           divisionno, me_no, title, content, good, file1, file2, size2, cnt, replycnt, rdate, 
           grpno, indent, ansnum
    FROM board
    ORDER BY grpno DESC, ansnum ASC
  </select>  
  
  <select id="list_by_divisionno" resultType="BoardVO" parameterType="int">
    SELECT boardno,
           divisionno, me_no, title, content, good, file1, file2, size2, cnt, replycnt, rdate, 
           grpno, indent, ansnum
    FROM board
    WHERE divisionno=#{divisionno}
    ORDER BY grpno DESC, ansnum ASC
  </select>  
  
  <select id="read" resultType="BoardVO" parameterType="int">
    SELECT boardno,
               divisionno, me_no, title, content, good, file1, file2, size2, cnt, replycnt, rdate, 
               grpno, indent, ansnum
    FROM board
    WHERE boardno=#{boardno}
  </select>  
  
  <update id='update' parameterType="BoardVO">
    UPDATE board
    SET title=#{title}, content=#{content}, file1=#{file1}, file2=#{file2}, size2=#{size2}
    WHERE boardno=#{boardno}
  </update>
  
  <delete id="delete" parameterType="int">
    DELETE FROM board
    WHERE boardno=#{boardno}
  </delete>
  
 <!-- ********** 검색에 따른 변경 시작 ********** -->
  <select id="list2" resultType="BoardVO" parameterType="HashMap" >
    SELECT boardno,
       divisionno, me_no, title, good, file1, file2, size2, cnt, replycnt, rdate, 
       grpno, indent, ansnum
    FROM board
    WHERE divisionno=#{divisionno}
    
    <choose>
      <when test="col == 'title'">
         AND title LIKE '%' || #{word} || '%' 
      </when>
      <when test="col == 'content'">
         AND content LIKE '%' || #{word} || '%' 
      </when>
      <when test="col == 'title_content'">
         AND title LIKE '%' || #{word} || '%'  OR content LIKE '%' || #{word} || '%' 
      </when>
    </choose>
    
    ORDER BY boardno DESC
  </select>        
 
  <select id="count" resultType="int" parameterType="HashMap" >
    SELECT COUNT(*) as cnt
    FROM board
    WHERE divisionno=#{divisionno}
    
    <choose>
      <when test="col == 'title'">
        AND title LIKE '%' || #{word} || '%' 
      </when>
      <when test="col == 'content'">
        AND content LIKE '%' || #{word} || '%' 
      </when>
      <when test="col == 'title_content'">
        AND title LIKE '%' || #{word} || '%'  OR content LIKE '%' || #{word} || '%' 
      </when>      
    </choose>
  </select>        
 
  <!-- ********** 검색에 따른 변경 종료 ********** -->   
  
  <!-- ********** 페이징에 따른 시작 ********** -->
   <select id="list3" resultType="BoardVO" parameterType="HashMap" >
    SELECT boardno, divisionno, title, content, good, file1, file2, size2, cnt, replycnt, rdate, grpno, indent, ansnum, r
    FROM(
       SELECT boardno, divisionno, title, content, good, file1, file2, size2, cnt, replycnt, rdate, grpno, indent, ansnum, rownum as r
       FROM(
            SELECT boardno, divisionno, title, content, good, file1, file2, size2, cnt, replycnt, rdate, grpno, indent, ansnum
            FROM board
            WHERE divisionno=#{divisionno}
            <choose>
              <when test="col == 'title'">
                 AND title LIKE '%' || #{word} || '%' 
              </when>
              <when test="col == 'content'">
                 AND content LIKE '%' || #{word} || '%' 
              </when>
              <when test="col == 'title_content'">
                 AND title LIKE '%' || #{word} || '%'  OR content LIKE '%' || #{word} || '%' 
              </when>      
            </choose>
            ORDER BY boardno DESC
       )
    )
    WHERE <![CDATA[r >=#{startNum} AND r <= #{endNum}]]>
  </select>  
  <!-- ********** 페이징에 따른 종료 ********** -->
  
  <!-- ********** 답변 시작 ********** -->
  <!-- 답변 순서 변경 -->
    <update id='updateAnsnum' parameterType="BoardVO">
    UPDATE board
    SET ansnum = ansnum + 1
    WHERE divisionno = #{divisionno} AND grpno = #{grpno} AND ansnum > #{ansnum}
  </update>
 
  <!-- 답변 등록 -->
  <insert id="reply" parameterType="BoardVO">
    INSERT INTO board(boardno,
                  divisionno, me_no, title, content, good, file1, file2, size2, rdate, 
                  grpno, indent, ansnum)   
    VALUES((SELECT NVL(MAX(boardno), 0) + 1 as boardno FROM board),
                          #{divisionno}, #{me_no}, #{title}, #{content}, 0, #{file1}, #{file2}, #{size2}, sysdate,
                          #{grpno}, #{indent}, #{ansnum})
  </insert>

  <select id="list4" resultType="BoardVO" parameterType="HashMap" >
    SELECT boardno, divisionno, me_no, title, content, good, 
               file1, file2, size2, cnt, replycnt, rdate, grpno, indent, ansnum, r
    FROM(
             SELECT boardno, divisionno, me_no, title, content, good,
                        file1, file2, size2, cnt, replycnt, rdate, grpno, indent, ansnum, rownum as r
             FROM(
                      SELECT boardno, divisionno, me_no, title, content, good,
                                 file1, file2, size2, cnt, replycnt, rdate, grpno, indent, ansnum
                      FROM board
 
                      WHERE divisionno=#{divisionno}
                      <choose>
                        <when test="col == 'title'">
                           AND title LIKE '%' || #{word} || '%' 
                        </when>
                        <when test="col == 'content'">
                           AND content LIKE '%' || #{word} || '%' 
                        </when>
                        <when test="col == 'title_content'">
                           AND title LIKE '%' || #{word} || '%'  OR content LIKE '%' || #{word} || '%' 
                        </when>      
                      </choose>
                      ORDER BY grpno DESC, ansnum ASC
             )
    )
    WHERE <![CDATA[r >=#{startNum} AND r <= #{endNum}]]>
  </select> 
  <!-- ********** 답변 종료 ********** -->
</mapper>
