<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- Oracle 기반 -->
<mapper namespace = "ifree">
  <insert id="create" parameterType="IfreeVO">
    INSERT INTO commu_info(cm_no, cm_nick, cm_title, cm_content, file1, file2, size2, cm_likeit, cm_map, cm_url, 
                        cm_cnt, cm_date, replycnt, grpno, indent, ansnum)
    VALUES ((SELECT NVL(MAX(cm_no), 0)+1 as cm_no FROM commu_info), 
                                  #{cm_nick}, #{cm_title}, #{cm_content}, #{file1}, #{file2}, #{size2}, 0, 
                                  #{cm_map}, #{cm_url}, 0, sysdate, 0, (SELECT NVL(MAX(grpno), 0) + 1 as grpno FROM commu_info), 0, 0)
  </insert>
  
  <update id='update' parameterType="IfreeVO">
    UPDATE commu_info
    SET cm_title=#{cm_title}, cm_content=#{cm_content}, file1=#{file1}, file2=#{file2}, size2=#{size2},
        cm_map=#{cm_map}, cm_url=#{cm_url}
    WHERE cm_no=#{cm_no}
  </update>  
  
  <update id='update_cnt' parameterType="IfreeVO">
    UPDATE commu_info
    SET cm_cnt = cm_cnt + 1
    WHERE cm_no=#{cm_no}
  </update>   
  
  <delete id="delete" parameterType="int">
    DELETE FROM commu_info
    WHERE cm_no=#{cm_no}
  </delete>  
  
  <select id="read" resultType="IfreeVO">
    SELECT cm_no, cm_nick, cm_title, cm_content, file1, file2, size2, cm_likeit, cm_map, cm_url, 
                        cm_cnt, cm_date, replycnt, grpno, indent, ansnum
    FROM commu_info
    WHERE cm_no = #{cm_no}
  </select>

 <!-- **********       관련글 관련 시작       ********** -->  
  <select id="maxlist" resultType="int">
    SELECT NVL(MAX(cm_no), 0) as cm_no 
    FROM commu_info
    where indent = 0
  </select>
  
  <select id="minlist" resultType="int">
    SELECT NVL(MIN(cm_no), 0) as cm_no 
    FROM commu_info
    where indent = 0
  </select>
 
  <select id="bonlist" resultType="IfreeVO">
  SELECT cm_no, cm_title, cm_date, grpno
  FROM(         
            SELECT cm_no, cm_title, cm_date, grpno, rownum
            from commu_info
      where ansnum = 0
      order by cm_no
  )
  </select>
  
  <select id="bonread" resultType="IfreeVO">
        SELECT cm_no, cm_nick, cm_title, cm_content, file1, file2, size2, cm_likeit, cm_map, cm_url, 
                          cm_cnt, cm_date, replycnt, grpno, indent, ansnum, rownum
    FROM(         
              SELECT cm_no, cm_nick, cm_title, cm_content, file1, file2, size2, cm_likeit, cm_map, cm_url, 
                          cm_cnt, cm_date, replycnt, grpno, indent, ansnum, rownum
              from commu_info
        where ansnum = 0
        order by cm_no
    )
    where grpno = #{grpno}
  </select>
  
  <select id="listmenu" resultType="IfreeVO">
    select cm_no, cm_nick, cm_title, cm_date, grpno, indent, ansnum
    from commu_info
    where grpno = #{grpno}
    order by ansnum
  </select>  
 <!-- **********       관련글 관련 종료       ********** -->  
  
 <!-- **********       답변 관련 시작       ********** -->
  <!-- 답변 순서 변경 -->
  <update id='updateAnsnum' parameterType="IfreeVO">
    UPDATE commu_info
    SET ansnum = ansnum + 1
    WHERE grpno = #{grpno} AND ansnum > #{ansnum}
  </update>
 
  <!-- 답변 등록 -->
  <insert id="reply" parameterType="IfreeVO">
    INSERT INTO commu_info(cm_no, cm_nick, cm_title, cm_content, file1, file2, size2, cm_likeit, cm_map, cm_url, 
                           cm_cnt, cm_date, replycnt, grpno, indent, ansnum)  
    VALUES((SELECT NVL(MAX(cm_no), 0) + 1 as cm_no FROM commu_meet), #{cm_nick},
            #{cm_title}, #{cm_content}, #{file1}, #{file2}, #{size2}, 0, #{cm_map}, #{cm_url}, 0, sysdate, 0,
            #{grpno}, #{indent}, #{ansnum})
  </insert>
 
  <!-- 답변에 따른 목록 -->
  <select id="list" resultType="IfreeVO" parameterType="HashMap" >
    SELECT cm_no, cm_nick, cm_title, cm_content, file1, file2, size2, cm_likeit, cm_map, cm_url, 
                cm_cnt, cm_date, replycnt, grpno, indent, ansnum, r 
    FROM(             
         SELECT cm_no, cm_nick, cm_title, cm_content, file1, file2, size2, cm_likeit, cm_map, cm_url, 
                cm_cnt, cm_date, replycnt, grpno, indent, ansnum, rownum as r
          FROM(
                    SELECT cm_no, cm_nick, cm_title, cm_content, file1, file2, size2, cm_likeit, cm_map, cm_url, 
                           cm_cnt, cm_date, replycnt, grpno, indent, ansnum
               FROM commu_info
              <choose>
              <when test="col == 'title'">
                WHERE cm_title LIKE '%' || #{word} || '%' 
              </when>
              <when test="col == 'content'">
                WHERE cm_content LIKE '%' || #{word} || '%' 
              </when>
              <when test="col == 'title_content'">
                WHERE cm_title LIKE '%' || #{word} || '%'  OR cm_content LIKE '%' || #{word} || '%' 
              </when>        
              </choose>
              ORDER BY grpno DESC, ansnum ASC
          )
     )
    WHERE <![CDATA[r >=#{startNum} AND r <= #{endNum}]]>
  </select> 
  <!-- **********       답변 관련 종료       ********** -->
    <select id="count" resultType="int" parameterType="HashMap" >
    SELECT COUNT(*) as cnt
    FROM commu_info
    <choose>
      <when test="col == 'title'">
        WHERE cm_title LIKE '%' || #{word} || '%' 
      </when>
      <when test="col == 'content'">
        WHERE cm_content LIKE '%' || #{word} || '%' 
      </when>
      <when test="col == 'title_content'">
        WHERE cm_title LIKE '%' || #{word} || '%'  OR cm_content LIKE '%' || #{word} || '%' 
      </when>      
    </choose>
  </select>   
</mapper>